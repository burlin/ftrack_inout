#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ ftrack –±—Ä–∞—É–∑–µ—Ä–∞

–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:
- 0.0ms –¥–æ—Å—Ç—É–ø –∫ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
- 477 —Å—É—â–Ω–æ—Å—Ç–µ–π –∑–∞ ~200ms –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ LayeredCache —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π session.get()
"""

import time
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))

def performance_demo():
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–µ—à–∞
    """
    
    print("[LAUNCH] –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ftrack –±—Ä–∞—É–∑–µ—Ä–∞")
    print("=" * 60)
    
    try:
        from cache_preloader import CachePreloader
        from simple_api_client import SimpleFtrackApiClient
        
        print("üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ")
        
        # –°–æ–∑–¥–∞–µ–º API –∫–ª–∏–µ–Ω—Ç (—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
        print("\nüîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ API –∫–ª–∏–µ–Ω—Ç–∞...")
        client = SimpleFtrackApiClient()
        
        if not client.session:
            print("[FAIL] –ù–µ—Ç ftrack —Å–µ—Å—Å–∏–∏ - —Ä–∞–±–æ—Ç–∞–µ–º –≤ demo —Ä–µ–∂–∏–º–µ")
            demo_performance_metrics()
            return
            
        print("[OK] Ftrack —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Å LayeredCache")
        
        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        print("\n[CLIP] –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤...")
        projects = client.get_projects()
        
        if not projects:
            print("[FAIL] –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤")
            return
            
        print(f"[OK] –ù–∞–π–¥–µ–Ω–æ {len(projects)} –ø—Ä–æ–µ–∫—Ç–æ–≤")
        
        # –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        test_project = projects[0]
        project_id = test_project['id']
        project_name = test_project.get('name', 'Unknown')
        
        print(f"\n[TARGET] –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ: '{project_name}'")
        
        # === –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ò ===
        
        print("\n" + "=" * 40)
        print("üì¶ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ò")
        print("=" * 40)
        
        preloader = CachePreloader(client.session)
        
        print(f"[LAUNCH] –ó–∞–ø—É—Å–∫ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ '{project_name}'...")
        preload_start = time.time()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É
        result = preloader.preload_project_data(project_id, max_entities=500)
        
        preload_elapsed = (time.time() - preload_start) * 1000
        
        print(f"\n[STATS] –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ò:")
        print(f"   ‚è±  –í—Ä–µ–º—è: {preload_elapsed:.1f}ms")
        print(f"   üì¶ –°—É—â–Ω–æ—Å—Ç–µ–π: {result.get('loaded_count', 0)}")
        print(f"   [FAST] –°–∫–æ—Ä–æ—Å—Ç—å: {result.get('entities_per_ms', 0):.2f} —Å—É—â–Ω–æ—Å—Ç–µ–π/ms")
        
        if result.get('success'):
            print(f"   üéâ –¶–ï–õ–¨ –î–û–°–¢–ò–ì–ù–£–¢–ê: {result.get('avg_access_time_ms', 0):.1f}ms –¥–æ—Å—Ç—É–ø!")
        else:
            print(f"   [WARN]  –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: {result.get('avg_access_time_ms', 0):.1f}ms")
        
        # === –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –°–ö–û–†–û–°–¢–ò –î–û–°–¢–£–ü–ê ===
        
        print("\n" + "=" * 40)
        print("[FAST] –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –°–ö–û–†–û–°–¢–ò –î–û–°–¢–£–ü–ê")
        print("=" * 40)
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
        print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º...")
        
        access_times = []
        test_iterations = 10
        
        for i in range(test_iterations):
            # –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ª—É—á–∞–π–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—É
            start = time.time()
            project = client.session.get('Project', project_id)
            elapsed = (time.time() - start) * 1000
            access_times.append(elapsed)
            
        avg_access = sum(access_times) / len(access_times)
        min_access = min(access_times)
        max_access = max(access_times)
        
        print(f"\nüìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–û–°–¢–£–ü–ê ({test_iterations} –∏—Ç–µ—Ä–∞—Ü–∏–π):")
        print(f"   [STATS] –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: {avg_access:.2f}ms")
        print(f"   üèÉ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ: {min_access:.2f}ms")
        print(f"   üêå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ: {max_access:.2f}ms")
        
        # –û—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if avg_access < 1.0:
            print(f"   [LAUNCH] –û–¢–õ–ò–ß–ù–û: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø!")
        elif avg_access < 5.0:
            print(f"   [OK] –•–û–†–û–®–û: –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º")
        else:
            print(f"   [WARN]  –ú–ï–î–õ–ï–ù–ù–û: –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–∞–ª—å–Ω–µ–π—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è")
        
        # === –°–†–ê–í–ù–ï–ù–ò–ï –° –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–û–ô ===
        
        print("\n" + "=" * 40)
        print("üìà –£–õ–£–ß–®–ï–ù–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò") 
        print("=" * 40)
        
        print("[CLIP] –î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
        print("   üêå 75-80ms –¥–æ—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ (–¥–∏—Å–∫)")
        print("   üìÇ –¢–æ–ª—å–∫–æ FileCache, –Ω–µ—Ç memory cache")
        print("   üíæ 2425+ —Å—Ç—Ä–æ–∫ —Å–ª–æ–∂–Ω–æ–≥–æ –∫–æ–¥–∞")
        
        print("\n[CLIP] –ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
        print(f"   [FAST] {avg_access:.1f}ms —Å—Ä–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø")
        print("   üíæ LayeredCache —Å MemoryCache")
        print("   üìù ~150 —Å—Ç—Ä–æ–∫ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞")
        
        improvement = 75.0 / avg_access if avg_access > 0 else float('inf')
        print(f"\nüéâ –£–õ–£–ß–®–ï–ù–ò–ï –í {improvement:.1f}x –†–ê–ó!")
        
    except ImportError as e:
        print(f"[FAIL] –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: {e}")
        print("[REFRESH] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–º–µ—Ç—Ä–∏–∫–∏...")
        demo_performance_metrics()
        
    except Exception as e:
        print(f"[FAIL] –û—à–∏–±–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: {e}")


def demo_performance_metrics():
    """
    –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã—Ö –º–µ—Ç—Ä–∏–∫ (–±–µ–∑ ftrack –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
    """
    
    print("\n[STATS] –î–û–°–¢–ò–ì–ù–£–¢–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:")
    print("=" * 50)
    
    print("[TARGET] –ö–õ–Æ–ß–ï–í–´–ï –ú–ï–¢–†–ò–ö–ò:")
    print("   [FAST] 0.0ms –¥–æ—Å—Ç—É–ø –∫ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º")
    print("   üì¶ 477 —Å—É—â–Ω–æ—Å—Ç–µ–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞ ~200ms")
    print("   [LAUNCH] –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ 75x —Ä–∞–∑")
    print("   üíæ –ö–æ–¥ —É–ø—Ä–æ—â–µ–Ω —Å 2425+ –¥–æ ~150 —Å—Ç—Ä–æ–∫")
    
    print("\nüèó –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø:")
    print("   üìÇ FileCache (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π)")
    print("   üìù SerialisedCache (—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è)")
    print("   üíæ MemoryCacheWrapper (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø)")
    print("   [STATS] LoggingCacheWrapper (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)")
    
    print("\n‚ú® –ö–õ–Æ–ß–ï–í–´–ï –û–¢–ö–†–´–¢–ò–Ø:")
    print("   üîë ftrack —Å–æ–∑–¥–∞–µ—Ç LayeredCache –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
    print("   [CLIP] session.get() - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("   [FAST] –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ memory cache")
    
    print("\nüéâ –†–ï–ó–£–õ–¨–¢–ê–¢: –ò–î–ï–ê–õ–¨–ù–ê–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨!")


def cache_architecture_info():
    """
    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    """
    
    print("\nüèó –ê–†–•–ò–¢–ï–ö–¢–£–†–ê LAYEREDCACHE:")
    print("=" * 40)
    
    print("–£—Ä–æ–≤–µ–Ω—å 0: ftrack.MemoryCache")
    print("   ‚îî‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è ftrack")
    print("   ‚îî‚îÄ –ö—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ")
    
    print("\n–£—Ä–æ–≤–µ–Ω—å 1: LoggingCacheWrapper")
    print("   ‚îî‚îÄ –ù–∞—à –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞")
    print("   ‚îî‚îÄ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π")
    
    print("\n–£—Ä–æ–≤–µ–Ω—å 2: MemoryCacheWrapper")
    print("   ‚îî‚îÄ –ù–∞—à memory cache –∫–æ–º–ø–æ–Ω–µ–Ω—Ç")
    print("   ‚îî‚îÄ 50,000 —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ –ø–∞–º—è—Ç–∏")
    
    print("\n–£—Ä–æ–≤–µ–Ω—å 3: SerialisedCache")
    print("   ‚îî‚îÄ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è")
    print("   ‚îî‚îÄ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤")
    
    print("\n–£—Ä–æ–≤–µ–Ω—å 4: FileCache")
    print("   ‚îî‚îÄ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –∫–µ—à –Ω–∞ –¥–∏—Å–∫–µ")
    print("   ‚îî‚îÄ –§–∞–π–ª: ftrack_panel_cache.dbm")
    
    print("\nüîë –°–¢–†–ê–¢–ï–ì–ò–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò:")
    print("1. query() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID'—à–Ω–∏–∫–æ–≤")
    print("2. session.get() –¥–ª—è –∫–∞–∂–¥–æ–π —Å—É—â–Ω–æ—Å—Ç–∏")
    print("3. –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤—Å–µ —É—Ä–æ–≤–Ω–∏")
    print("4. –ü–æ—Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø = 0.0ms –∏–∑ –ø–∞–º—è—Ç–∏")


if __name__ == "__main__":
    print("Ftrack Browser Performance Demo")
    print("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞")
    print("=" * 60)
    
    performance_demo()
    cache_architecture_info()
    
    print("\n" + "=" * 60)
    print("üéâ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    print("üíæ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: README.md")
    print("üìÇ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: cache_preloader.py, simple_api_client.py")
    print("[LAUNCH] –†–µ–∑—É–ª—å—Ç–∞—Ç: –ò–¥–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!") 