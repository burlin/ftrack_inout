# Руководство по тестированию браузера с общим кешем

## Быстрый тест

Запустите браузер и проверьте логи:

```bash
python run_browser.py
```

## Что проверить в логах

### 1. Использование общего механизма кеширования

Ищите в логах сообщения:

```
[OK] Using shared session from common session factory
```

или

```
[OK] Using shared session from common factory
```

### 2. Тип кеша

В логах должно быть указано использование оптимизированного кеша:

```
Cache type: <class 'ftrack_inout.browser.cache_wrapper.LoggingCacheWrapper'>
```

или

```
Cache class: LoggingCacheWrapper
```

### 3. Производительность

При работе с браузером проверьте:

- **Быстрая загрузка версий:** После первого запроса последующие должны быть мгновенными (~0.0ms)
- **Логи показывают:** `[STATS] Query: X.Xs, Batch get: X.Xs` с быстрым batch get

### 4. Fallback механизм

Если общий механизм недоступен, должен работать fallback:

```
Common session factory not available, using local session cache
```

## Тестирование функциональности

### Тест 1: Загрузка проектов

1. Запустите браузер
2. Выберите проект
3. Проверьте время загрузки в логах

**Ожидаемый результат:**
- Первая загрузка: ~1-2 секунды (query)
- Последующие загрузки: ~0.0ms (из кеша)

### Тест 2: Загрузка версий ассета

1. Выберите ассет
2. Загрузите версии
3. Обновите список версий (Refresh)

**Ожидаемый результат:**
- Первая загрузка: ~1-2 секунды
- Refresh с `force_refresh=True`: ~1.5 секунды (обновление метаданных)
- Повторная загрузка: ~0.0ms (из кеша)

### Тест 3: Загрузка компонентов

1. Выберите версию
2. Загрузите компоненты
3. Обновите компоненты (Refresh)

**Ожидаемый результат:**
- Первая загрузка: ~0.5-2 секунды
- Refresh с `force_refresh=True`: обновляет `component_locations`
- Повторная загрузка: ~0.0ms (из кеша)

## Проверка кода

### Проверка импортов

Убедитесь, что модули используют общий механизм:

```python
# В browser_widget.py
from ..common.session_factory import get_shared_session

# В browser_widget_optimized.py  
from ..common.session_factory import get_shared_session

# В publisher модулях
from ...common.session_factory import get_shared_session
```

### Проверка вызовов

Ищите в коде вызовы:

```python
session = get_shared_session()
```

вместо прямого создания:

```python
session = ftrack_api.Session()  # Старый способ
```

## Автоматический тест

Запустите тестовый скрипт:

```bash
python test_browser_cache.py
```

**Ожидаемый результат:**
- ✅ Common session factory module imported successfully
- ✅ Shared session created (если ftrack_api доступен)
- ✅ Browser widget created successfully
- ✅ Cache type указывает на оптимизированный кеш

## Устранение проблем

### Проблема: Сессия не создается

**Причина:** ftrack_api не доступен или неправильно настроен

**Решение:**
1. Проверьте переменные окружения: `FTRACK_SERVER`, `FTRACK_API_KEY`, `FTRACK_API_USER`
2. Проверьте пути к зависимостям в `run_browser.py`
3. Убедитесь, что `ftrack_api` установлен или находится в `ftrack_inout/dependencies`

### Проблема: Кеш не используется

**Причина:** Общий механизм недоступен, используется fallback

**Решение:**
1. Проверьте, что `ftrack_inout/common/` доступен в sys.path
2. Проверьте логи на наличие ошибок импорта
3. Убедитесь, что `FTRACK_CACHE` переменная окружения установлена

### Проблема: Медленная работа

**Причина:** Кеш не работает или не оптимизирован

**Решение:**
1. Проверьте тип кеша в логах
2. Убедитесь, что используется `MemoryCacheWrapper`
3. Проверьте, что `FTRACK_CACHE` указывает на существующий путь

## Метрики производительности

После тестирования проверьте:

1. **Время первого запроса:** Должно быть ~1-2 секунды (query)
2. **Время доступа из кеша:** Должно быть ~0.0ms
3. **Ускорение:** Должно быть ~14,000x (см. `CACHE_REFRESH_ANALYSIS.md`)

## Следующие шаги

После успешного тестирования:

1. ✅ Браузер использует общий механизм кеширования
2. ✅ Производительность соответствует ожиданиям
3. ✅ Fallback механизм работает корректно
4. ✅ Логи показывают правильное использование кеша

## Дополнительная информация

- Детальный анализ производительности: `ftrack_inout/common/CACHE_REFRESH_ANALYSIS.md`
- Сводка интеграции: `ftrack_inout/common/CACHE_INTEGRATION_SUMMARY.md`
- Тест производительности: `test_cache_performance.py`
